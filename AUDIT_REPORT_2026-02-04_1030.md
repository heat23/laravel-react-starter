# AUDIT_REPORT
generated: 2026-02-04
status: ready
stack: laravel/react
audit_type: full
depth: thorough

## EXECUTIVE_SUMMARY

### Critical Findings (P0)
- **3** security issues requiring immediate fix (authorization gaps)
- **3** rate limiting gaps on auth endpoints

### Important Findings (P1)
- **1** minor performance issue (code duplication)
- **5** test coverage gaps (missing tests for critical paths)
- **4** UX improvements needed (error messages, loading states)

### Polish Items (P2)
- **1** tech debt item (TODO comment)
- **3** minor UX enhancements

---

## FINDINGS

### P0_CRITICAL

#### SEC-001: Missing Rate Limiting on Registration
file: routes/auth.php:18
type: security
severity: critical
issue: |
  Registration endpoint lacks rate limiting, enabling:
  - Account enumeration attacks
  - Registration spam/bot abuse
  - Potential DoS via expensive user creation
evidence: |
  ```php
  Route::post('register', [RegisteredUserController::class, 'store']);
  // No throttle middleware
  ```
fix: |
  ```php
  Route::post('register', [RegisteredUserController::class, 'store'])
      ->middleware('throttle:5,1'); // 5 attempts per minute
  ```
test: |
  Attempt 6 registrations in 1 minute - should receive 429 response on 6th attempt

---

#### SEC-002: Missing Rate Limiting on Password Reset Request
file: routes/auth.php:28-29
type: security
severity: critical
issue: |
  Password reset request endpoint lacks rate limiting, enabling:
  - Email enumeration attacks
  - Email spam to arbitrary addresses
evidence: |
  ```php
  Route::post('forgot-password', [PasswordResetLinkController::class, 'store'])
      ->name('password.email');
  // No throttle middleware
  ```
fix: |
  ```php
  Route::post('forgot-password', [PasswordResetLinkController::class, 'store'])
      ->middleware('throttle:3,1')
      ->name('password.email');
  ```
test: |
  Attempt 4 password resets in 1 minute - should receive 429 on 4th attempt

---

#### SEC-003: Missing Rate Limiting on Password Reset Store
file: routes/auth.php:34-35
type: security
severity: critical
issue: |
  Password reset submission endpoint lacks rate limiting
evidence: |
  ```php
  Route::post('reset-password', [NewPasswordController::class, 'store'])
      ->name('password.store');
  // No throttle middleware
  ```
fix: |
  ```php
  Route::post('reset-password', [NewPasswordController::class, 'store'])
      ->middleware('throttle:5,1')
      ->name('password.store');
  ```
test: |
  Attempt 6 password reset submissions in 1 minute - should receive 429 on 6th

---

#### SEC-004: API Token Delete - Missing Ownership Verification Response
file: routes/api.php:79-82
type: security
severity: high
issue: |
  Token deletion returns success even when token doesn't exist or doesn't belong to user.
  While the query is scoped to user's tokens (safe), the response doesn't differentiate
  between "token deleted" and "token not found/not yours", which could leak information.
evidence: |
  ```php
  Route::delete('/{tokenId}', function (Request $request, $tokenId) {
      $request->user()->tokens()->where('id', $tokenId)->delete();
      return response()->json(['success' => true]); // Always returns success
  });
  ```
fix: |
  ```php
  Route::delete('/{tokenId}', function (Request $request, $tokenId) {
      $deleted = $request->user()->tokens()->where('id', $tokenId)->delete();
      if (!$deleted) {
          return response()->json(['message' => 'Token not found.'], 404);
      }
      return response()->json(['success' => true]);
  });
  ```
test: |
  Try to delete a non-existent token ID - should return 404, not 200

---

#### SEC-005: Race Condition in Social Account Disconnect
file: app/Http/Controllers/Auth/SocialAuthController.php:95-116
type: security
severity: high
issue: |
  Non-atomic check between counting social accounts and deleting one.
  Two concurrent requests could both pass the check, leaving user with no auth method.
evidence: |
  ```php
  if (! $user->hasPassword()) {
      $socialAccountCount = $user->socialAccounts()->count();
      if ($socialAccountCount <= 1) {
          return back()->with('error', '...');
      }
  }
  // Window between check and delete
  $user->socialAccounts()->where('provider', $provider)->delete();
  ```
fix: |
  Wrap in database transaction:
  ```php
  DB::transaction(function () use ($user, $provider) {
      $user->lockForUpdate();
      if (! $user->hasPassword() && $user->socialAccounts()->count() <= 1) {
          throw new \Exception('Cannot disconnect last auth method');
      }
      $user->socialAccounts()->where('provider', $provider)->delete();
  });
  ```
test: |
  Send two concurrent disconnect requests with different providers - second should fail

---

#### SEC-006: Profile Controller Missing Authorization Annotations
file: app/Http/Controllers/ProfileController.php:31,47
type: security
severity: medium
issue: |
  ProfileController update/destroy methods rely entirely on `$request->user()` without
  explicit authorization. While currently safe (routes use auth middleware), adding
  explicit `$this->authorize()` calls follows defense-in-depth principle.
evidence: |
  ```php
  public function update(ProfileUpdateRequest $request): RedirectResponse
  {
      $request->user()->fill($request->validated()); // No authorize() call
      // ...
  }

  public function destroy(Request $request): RedirectResponse
  {
      // Validates password but no authorize() call
      $user = $request->user();
      $user->delete();
  }
  ```
fix: |
  Create UserPolicy and add authorization:
  ```php
  // app/Policies/UserPolicy.php
  public function update(User $user, User $model): bool
  {
      return $user->id === $model->id;
  }

  public function delete(User $user, User $model): bool
  {
      return $user->id === $model->id;
  }

  // ProfileController.php
  public function update(ProfileUpdateRequest $request): RedirectResponse
  {
      $this->authorize('update', $request->user());
      // ...
  }
  ```
test: |
  Verify policy is registered and authorization works

---

### P1_IMPORTANT

#### TEST-001: Missing Test Coverage - Password Reset Flow
file: tests/Feature/Auth/
type: test_coverage
severity: high
issue: |
  No tests exist for password reset flow:
  - Password reset request
  - Password reset with token
  - Invalid token handling
  - Expired token handling
impact: |
  Password reset bugs could go undetected, affecting user recovery
fix: |
  Create tests/Feature/Auth/PasswordResetTest.php with:
  - test_reset_password_link_screen_can_be_rendered
  - test_reset_password_link_can_be_requested
  - test_password_can_be_reset_with_valid_token
  - test_password_cannot_be_reset_with_invalid_token

---

#### TEST-002: Missing Test Coverage - Email Verification
file: tests/Feature/Auth/
type: test_coverage
severity: high
issue: |
  No tests for email verification flow:
  - Verification notice screen
  - Verification with valid link
  - Verification with invalid/expired link
  - Resend verification email
fix: |
  Create tests/Feature/Auth/EmailVerificationTest.php

---

#### TEST-003: Missing Test Coverage - Profile Management
file: tests/Feature/
type: test_coverage
severity: high
issue: |
  No tests for profile controller:
  - Profile update
  - Profile deletion
  - Email change resets verification
fix: |
  Create tests/Feature/ProfileTest.php

---

#### TEST-004: Missing Test Coverage - API Tokens
file: tests/Feature/
type: test_coverage
severity: medium
issue: |
  No tests for API token management:
  - Token creation
  - Token listing
  - Token deletion
  - Token limits (free vs pro)
fix: |
  Create tests/Feature/ApiTokenTest.php

---

#### TEST-005: Missing Test Coverage - Social Authentication
file: tests/Feature/
type: test_coverage
severity: medium
issue: |
  No tests for social auth flow (when feature enabled):
  - Social login redirect
  - Social callback handling
  - Social account disconnect
fix: |
  Create tests/Feature/Auth/SocialAuthTest.php

---

#### PERF-001: Duplicate Token Endpoint in Routes
file: routes/api.php:49-59
type: performance
severity: low
issue: |
  Token listing logic duplicated between routes/api.php closure and ApiTokenController.
  This creates maintenance burden and potential inconsistency.
evidence: |
  Both files have nearly identical token mapping code
fix: |
  Remove route closure, use controller method exclusively:
  ```php
  Route::get('/', [ApiTokenController::class, 'index']);
  ```

---

#### UX-001: Generic Error Messages
file: resources/js/Pages/Profile/Edit.tsx:36
type: ux
severity: high
issue: |
  Timezone save error shows generic "Failed to update timezone" without context
evidence: |
  ```tsx
  catch (error) {
      toast.error("Failed to update timezone");
  }
  ```
fix: |
  ```tsx
  catch (error) {
      const message = error instanceof Error ? error.message : "Please try again";
      toast.error(`Failed to update timezone: ${message}`);
  }
  ```

---

#### UX-002: Missing Loading State on Timezone Save
file: resources/js/Pages/Profile/Edit.tsx:26-41
type: ux
severity: medium
issue: |
  Timezone selector doesn't show visual loading feedback during save.
  `isSaving` state exists but no spinner shown.
fix: |
  Add Loader2 icon from lucide-react when isSaving is true

---

#### UX-003: Dashboard Empty State as Plain Text
file: resources/js/Pages/Dashboard.tsx:91-96
type: ux
severity: medium
issue: |
  "No recent activity" shown as plain text, not using EmptyState component
evidence: |
  ```tsx
  <p className="text-sm text-muted-foreground">
    No recent activity to show.
  </p>
  ```
fix: |
  ```tsx
  <EmptyState
    icon={Activity}
    title="No Recent Activity"
    description="Your recent actions will appear here"
    size="sm"
  />
  ```

---

#### UX-004: Chart Placeholder in Dashboard
file: resources/js/Pages/Dashboard.tsx:76-79
type: ux
severity: medium
issue: |
  Placeholder text "Chart placeholder - integrate your preferred charting library"
  visible in production instead of proper empty state
fix: |
  Use EmptyState component or conditionally render based on data availability

---

### P2_POLISH

#### DEBT-001: TODO Comment in PlanLimitService
file: app/Services/PlanLimitService.php:76
type: tech_debt
severity: low
issue: |
  TODO comment for Cashier integration left in code
evidence: |
  ```php
  // TODO: Check actual subscription status via Cashier
  ```
fix: |
  Implement Cashier check when billing feature is enabled, or remove if not planned

---

#### UX-005: Profile Form Missing Client-Side Validation
file: resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.tsx
type: ux
severity: low
issue: |
  Profile form relies only on server-side validation.
  Login page uses Zod for real-time validation - same pattern should apply here.
fix: |
  Add Zod schema matching existing pattern from Login.tsx

---

#### UX-006: No Unsaved Changes Warning
file: resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.tsx
type: ux
severity: low
issue: |
  User can navigate away from form and lose unsaved data without warning
fix: |
  Use Inertia's built-in `useForm` dirty checking with beforeunload handler

---

#### UX-007: Password Confirm Field Missing Visibility Toggle
file: resources/js/Pages/Auth/Register.tsx:356
type: ux
severity: low
issue: |
  Main password field has visibility toggle, but confirm password field doesn't
fix: |
  Add show/hide toggle matching the main password field pattern

---

## VERIFIED_GOOD

Items checked that are correctly implemented:

### Security
- [x] **Login rate limiting** - 5 attempts per throttle key with Lockout event (LoginRequest.php:73-89)
- [x] **CSRF protection** - Automatic via Laravel web middleware
- [x] **Password hashing** - Automatic via 'hashed' cast (User.php:57)
- [x] **Email verification** - Signed URLs with rate limiting (routes/auth.php:44-46)
- [x] **Social account tokens encrypted** - 'encrypted' cast (SocialAccount.php:42-49)
- [x] **Mass assignment protection** - Explicit $fillable arrays (User.php:28-34)
- [x] **Session regeneration on login** - Prevents session fixation (AuthenticatedSessionController.php:46)
- [x] **Session invalidation on logout** - Complete session cleanup (AuthenticatedSessionController.php:60-71)
- [x] **Social provider validation** - Whitelist check before OAuth redirect (SocialAuthController.php:34-51)
- [x] **No SQL injection** - No raw queries without bindings
- [x] **No XSS vulnerabilities** - No dangerouslySetInnerHTML usage
- [x] **No hardcoded secrets** - All credentials via env variables

### Performance
- [x] **Database indexes** - All FKs indexed, composite indexes on frequently queried columns
- [x] **User settings caching** - 1-hour cache with invalidation (UserSetting.php:45-64)
- [x] **Feature flags** - Clean enable/disable without code changes
- [x] **No N+1 queries** - Queries properly scoped

### UX
- [x] **Comprehensive dark mode** - ThemeProvider with system preference detection
- [x] **Loading states** - LoadingButton component, auth pages have spinners
- [x] **Accessibility** - ARIA labels, semantic HTML, skip-to-content link
- [x] **Responsive navigation** - Mobile menu with Sheet component
- [x] **Destructive action confirmation** - Account deletion requires password + dialog
- [x] **Success feedback** - Toast notifications, inline success messages

### Code Quality
- [x] **No TypeScript any** - No `any` types found in codebase
- [x] **Clean component structure** - UI primitives in Components/ui/, pages in Pages/
- [x] **Form request validation** - Dedicated request classes for complex validation

---

## IMPLEMENTATION_ORDER

Execute fixes in this order:

### Immediate (Before Production)
1. **SEC-001** - Add rate limiting to registration
2. **SEC-002** - Add rate limiting to password reset request
3. **SEC-003** - Add rate limiting to password reset store
4. **SEC-004** - Fix token deletion response
5. **SEC-005** - Make social disconnect atomic

### High Priority (This Sprint)
6. **SEC-006** - Add UserPolicy and authorization
7. **TEST-001** - Password reset tests
8. **TEST-002** - Email verification tests
9. **TEST-003** - Profile tests
10. **UX-001** - Improve error messages

### Standard Priority
11. **TEST-004** - API token tests
12. **TEST-005** - Social auth tests
13. **PERF-001** - Remove duplicate token endpoint
14. **UX-002** - Add loading state to timezone
15. **UX-003** - Dashboard empty state

### Polish
16. **UX-004** - Chart placeholder
17. **DEBT-001** - Remove/implement TODO
18. **UX-005** - Client-side validation
19. **UX-006** - Unsaved changes warning
20. **UX-007** - Password confirm toggle

---

## NEXT_STEPS

Audit complete. To implement fixes:

1. **Review findings** for accuracy against your specific requirements
2. **Start new session** for fresh context
3. **Run:** `/vibe-build AUDIT_REPORT_2026-02-04_1030.md`

### Estimated Effort
- **P0 fixes:** 6 items (rate limiting, authorization, atomic operations)
- **P1 fixes:** 9 items (tests, UX improvements)
- **P2 fixes:** 5 items (polish, minor enhancements)

### Recommended Approach
Given the P0 security findings, recommend:
1. Fix all SEC-* issues first (30-60 minutes)
2. Run `/vibe-build` with this report for automated implementation
3. After security fixes, tackle test coverage gaps
