# AUDIT_REPORT
generated: 2026-02-05
status: ready
stack: laravel/react (Inertia.js + TypeScript + Tailwind CSS v4)
audit_type: full
depth: thorough

## EXECUTIVE_SUMMARY

### Critical Findings (P0)
- **0** security vulnerabilities requiring immediate fix
- **1** CORS configuration issue (too permissive for production)

### Important Findings (P1)
- **3** performance issues (N+1 queries, large Inertia payloads)
- **2** test coverage gaps (E2E tests, integration tests)
- **2** UX issues (form data loss, accessibility)
- **2** code pattern issues (API calls in components, feature flag naming)

### Polish Items (P2)
- **8** ESLint/lint warnings to clean up
- **5** UX polish items (loading states, dark mode)
- **6** tech debt items (unused imports, code duplication)

**Overall Security Grade: A-** — Production-ready after addressing P0/P1 items.

---

## FINDINGS

### P0_CRITICAL

#### SEC-001: CORS Configuration Too Permissive
file: `config/cors.php:15-25`
type: security
severity: critical

issue: |
  CORS allows ALL origins (`'*'`), ALL methods, and ALL headers. This is too permissive for production SPAs.

evidence: |
  ```php
  'allowed_origins' => ['*'],       // Line 15 - accepts ALL origins
  'allowed_methods' => ['*'],       // Line 13 - allows all HTTP methods
  'allowed_headers' => ['*'],       // Line 19 - allows all headers
  ```

fix: |
  ```php
  // config/cors.php
  'allowed_origins' => explode(',', env('CORS_ALLOWED_ORIGINS', 'http://localhost:3000')),
  'allowed_methods' => ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
  'allowed_headers' => ['Content-Type', 'Authorization', 'X-Requested-With', 'X-XSRF-TOKEN'],
  ```

  Add to `.env.example`:
  ```
  CORS_ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com
  ```

test: |
  1. Set restrictive CORS in .env
  2. Try accessing API from unauthorized origin
  3. Verify request is blocked

---

### P1_IMPORTANT

#### PERF-001: N+1 Query in ApiTokenController
file: `app/Http/Controllers/ApiTokenController.php:30,64`
type: performance
severity: high

issue: |
  Token listing executes `->get()` then `->map()`, loading all tokens into memory. Separate `->count()` query adds overhead.

evidence: |
  ```php
  // Line 30 - loads all tokens then maps
  $tokens = $request->user()->tokens()->get()->map(function ($token) { ... });

  // Line 64 - separate count query
  $currentTokenCount = $user->tokens()->count();
  ```

fix: |
  ```php
  // Use pagination and combine queries
  $tokens = $request->user()->tokens()
      ->select(['id', 'name', 'abilities', 'last_used_at', 'created_at'])
      ->paginate(15);

  // Count included in pagination metadata
  ```

test: |
  Create user with 50+ tokens, verify single query with `DB::enableQueryLog()`.

---

#### PERF-002: Large Inertia Payload (Full User Model)
file: `app/Http/Middleware/HandleInertiaRequests.php:35`
type: performance
severity: high

issue: |
  Full User model shared on every Inertia request. Includes unnecessary fields like `stripe_id`, `trial_ends_at`, nullable timestamps.

evidence: |
  ```php
  'auth' => [
      'user' => $request->user(),  // Entire model! ~500+ bytes per request
  ],
  ```

fix: |
  ```php
  'auth' => [
      'user' => $request->user() ? [
          'id' => $request->user()->id,
          'name' => $request->user()->name,
          'email' => $request->user()->email,
          'email_verified_at' => $request->user()->email_verified_at?->toISOString(),
          'has_password' => $request->user()->hasPassword(),
      ] : null,
  ],
  ```

test: |
  Compare network payload size before/after in browser DevTools.

---

#### PERF-003: Sync Email Event Blocks Registration
file: `app/Http/Controllers/Auth/RegisteredUserController.php:65-73`
type: performance
severity: medium

issue: |
  `Registered` event fires synchronously. If mail service is slow, registration endpoint blocks.

evidence: |
  ```php
  try {
      event(new Registered($user));  // Synchronous!
  } catch (\Throwable $e) {
      Log::error('Failed to send verification email during registration', ...);
  }
  ```

fix: |
  Make the event listener queue the email:
  ```php
  // app/Listeners/SendEmailVerificationNotification.php
  class SendEmailVerificationNotification implements ShouldQueue
  {
      use Queueable;
      // ...
  }
  ```

test: |
  Register user with slow mail driver, verify response time < 500ms.

---

#### SEC-002: Session Encryption Not Enabled
file: `config/session.php:31`
type: security
severity: medium

issue: |
  Session data stored unencrypted in database by default.

evidence: |
  ```php
  'encrypt' => env('SESSION_ENCRYPT', false),
  ```

fix: |
  ```php
  'encrypt' => env('SESSION_ENCRYPT', env('APP_ENV') === 'production'),
  ```

test: |
  Check database session table - data should be encrypted blob in production.

---

#### SEC-003: Missing Secure Cookie Default for Production
file: `config/session.php:106`
type: security
severity: medium

issue: |
  Session cookies may transmit over HTTP in production without explicit configuration.

evidence: |
  ```php
  'secure' => env('SESSION_SECURE_COOKIE'),  // null = HTTP allowed
  ```

fix: |
  ```php
  'secure' => env('SESSION_SECURE_COOKIE', env('APP_ENV') === 'production'),
  ```

test: |
  In production, verify cookie has `Secure` flag in browser DevTools.

---

#### TEST-001: No End-to-End Tests
file: (missing)
type: test_coverage
severity: high

issue: |
  No E2E tests for complete user flows: register → verify email → login → dashboard.

evidence: |
  - 158 backend tests (unit/feature)
  - 92 frontend tests (component)
  - 0 E2E tests (Playwright/Cypress)

fix: |
  1. Install Playwright: `npm init playwright@latest`
  2. Create `tests/e2e/auth.spec.ts` with:
     - Registration flow
     - Login flow
     - Password reset flow
     - Profile update flow

test: |
  `npx playwright test` passes all auth scenarios.

---

#### TEST-002: Missing Model Relationship Tests
file: `tests/Unit/Models/UserTest.php`
type: test_coverage
severity: medium

issue: |
  User model relationships (`socialAccounts()`, `settings()`) and methods (`getSetting()`, `setSetting()`) untested.

evidence: |
  UserTest.php exists but doesn't cover:
  - `$user->socialAccounts()` relationship
  - `$user->settings()` relationship
  - `$user->getSetting('key')` method
  - `$user->setSetting('key', 'value')` method

fix: |
  ```php
  test('user has many social accounts', function () {
      $user = User::factory()->create();
      SocialAccount::factory()->create(['user_id' => $user->id]);

      expect($user->socialAccounts)->toHaveCount(1);
  });

  test('user can get and set settings', function () {
      $user = User::factory()->create();
      $user->setSetting('theme', 'dark');

      expect($user->getSetting('theme'))->toBe('dark');
  });
  ```

test: |
  `php artisan test --filter=UserTest` passes relationship tests.

---

#### UX-001: No Form Data Loss Protection
file: `resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.tsx`
type: ux
severity: high

issue: |
  Users can navigate away from forms with unsaved changes without warning. Data loss possible.

evidence: |
  No `beforeunload` handler, no `isDirty` state tracking, no confirmation dialogs in:
  - UpdateProfileInformationForm.tsx
  - UpdatePasswordForm.tsx
  - DeleteUserForm.tsx

fix: |
  ```tsx
  // Add to form components
  const { data, isDirty } = useForm({ ... });

  useEffect(() => {
      const handleBeforeUnload = (e: BeforeUnloadEvent) => {
          if (isDirty) {
              e.preventDefault();
              e.returnValue = '';
          }
      };
      window.addEventListener('beforeunload', handleBeforeUnload);
      return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [isDirty]);
  ```

test: |
  1. Edit profile form
  2. Try to close tab
  3. Verify browser warning appears

---

#### UX-002: Incomplete Accessibility (aria-describedby)
file: `resources/js/Pages/Auth/Login.tsx` (and others)
type: ux
severity: medium

issue: |
  Form fields with error messages lack `aria-describedby` linking input to error.

evidence: |
  ```tsx
  <Input id="email" ... />
  <InputError message={errors.email} />
  // Missing: aria-describedby="email-error" on Input
  // Missing: id="email-error" on InputError
  ```

fix: |
  ```tsx
  <Input
      id="email"
      aria-describedby={errors.email ? 'email-error' : undefined}
      aria-invalid={!!errors.email}
      ...
  />
  <InputError id="email-error" message={errors.email} />
  ```

test: |
  Screen reader announces error message when field has error.

---

#### CODE-001: Direct API Call in Component
file: `resources/js/Pages/Profile/Edit.tsx:34`
type: code_pattern
severity: medium

issue: |
  Timezone selector makes direct axios call. Per CLAUDE.md, external API calls should use controllers/services.

evidence: |
  ```tsx
  const handleTimezoneChange = async (newTimezone: string) => {
      await axios.post("/api/settings", {
          key: "timezone",
          value: newTimezone,
      });
  };
  ```

fix: |
  Option 1: Use Inertia form instead of axios
  ```tsx
  router.post('/api/settings', { key: 'timezone', value: newTimezone });
  ```

  Option 2: Create dedicated controller endpoint
  ```php
  // routes/api.php
  Route::post('/settings/timezone', [SettingController::class, 'updateTimezone']);
  ```

test: |
  Verify timezone change persists after page reload.

---

### P2_POLISH

#### LINT-001: ESLint Import Spacing Warnings
file: Multiple test files (15+)
type: tech_debt
severity: low

issue: |
  Import statement spacing violations in test files.

fix: |
  ```bash
  npm run lint -- --fix
  ```

---

#### LINT-002: Unused Imports in Test Files
file: Multiple (8 files)
type: tech_debt
severity: low

issue: |
  Unused imports: `waitFor`, `fireEvent`, `within`, `container` in various test files.

evidence: |
  - `avatar.test.tsx:1` - `waitFor` unused
  - `checkbox.test.tsx:1` - `fireEvent` unused
  - `dialog.test.tsx:15-16` - `DialogOverlay`, `DialogPortal` unused
  - `select.test.tsx:1` - `within` unused

fix: |
  Remove unused imports or prefix with `_` if intentionally kept.

---

#### UX-003: Social Button Loading States Inconsistent
file: `resources/js/Pages/Auth/Login.tsx:156`
type: ux
severity: low

issue: |
  Social buttons not disabled during form processing (only during social loading).

fix: |
  ```tsx
  <Button disabled={socialLoading !== null || processing}>
  ```

---

#### UX-004: Dark Mode Token Coverage Incomplete
file: `resources/js/Pages/Auth/VerifyEmail.tsx:43`
type: ux
severity: low

issue: |
  Only 2 files explicitly use `dark:` variants. Status colors may have poor contrast in dark mode.

fix: |
  Use semantic tokens (`bg-success`, `text-success-foreground`) that have built-in dark mode support.

---

#### UX-005: Password Toggle Missing Focus Styles
file: `resources/js/Pages/Auth/Login.tsx:240-251`
type: ux
severity: low

issue: |
  Password visibility toggle button lacks focus ring for keyboard navigation.

fix: |
  ```tsx
  className="... focus:ring-2 focus:ring-ring focus:outline-none"
  aria-pressed={showPassword}
  ```

---

#### CODE-002: Form Validation Logic Duplicated
file: `resources/js/Pages/Auth/Login.tsx:48-55`
type: tech_debt
severity: low

issue: |
  Client-side validation pattern copy-pasted across multiple forms.

fix: |
  Extract to custom hook:
  ```tsx
  // hooks/useFormValidation.ts
  export function useFormValidation<T extends z.ZodSchema>(schema: T) {
      const [errors, setErrors] = useState<Record<string, string>>();
      const validate = (field: string, value: string) => { ... };
      return { errors, validate, clearError };
  }
  ```

---

#### CODE-003: LoadingButton Component Unused
file: `resources/js/Components/ui/loading-button.tsx`
type: tech_debt
severity: low

issue: |
  LoadingButton component exists but forms implement manual loading patterns.

fix: |
  Replace manual patterns with LoadingButton:
  ```tsx
  <LoadingButton loading={processing}>Sign in</LoadingButton>
  ```

---

#### CODE-004: Missing Type Interface Exports
file: `resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.tsx:19-29`
type: tech_debt
severity: low

issue: |
  User/PageProps interfaces defined locally but not exported for reuse.

fix: |
  Create `resources/js/types/models.ts`:
  ```tsx
  export interface User {
      id: number;
      name: string;
      email: string;
      email_verified_at: string | null;
  }
  ```

---

#### SEC-004: Missing Rate Limit on Settings API
file: `routes/api.php:32-42`
type: security
severity: low

issue: |
  POST /settings endpoint lacks rate limiting.

fix: |
  ```php
  Route::post('/settings', function (Request $request) {
      // ...
  })->middleware('throttle:30,1');
  ```

---

## VERIFIED_GOOD

Security measures correctly implemented:

- [x] Session regeneration on login (`AuthenticatedSessionController.php:48`)
- [x] CSRF protection via Sanctum middleware
- [x] Password hashing with bcrypt (Laravel default)
- [x] Rate limiting on auth routes (login: 5/min, register: 5/min, password reset: 3/min)
- [x] Signed URLs for email verification
- [x] Mass assignment protection (`$fillable` on all models)
- [x] No SQL injection vectors (proper Eloquent usage)
- [x] No XSS vectors (no `{!! !!}` or `dangerouslySetInnerHTML`)
- [x] OAuth tokens encrypted at rest (`SocialAccount.php:45-46`)
- [x] Password confirmation on destructive actions
- [x] Transaction locks prevent race conditions (`SocialAuthController.php:106`)
- [x] Feature flags gate optional functionality
- [x] Sensitive data hidden from serialization (`$hidden` arrays)
- [x] APP_KEY uses environment variable
- [x] No hardcoded secrets in codebase

Performance measures correctly implemented:

- [x] Vite manual chunks for vendor splitting
- [x] Test files excluded from build (`!**/*.test.{tsx,jsx}`)
- [x] UserSetting has cache with invalidation
- [x] Database session driver (scales horizontally)

Test coverage good areas:

- [x] Auth flows comprehensive (login, register, password reset, email verify)
- [x] Authorization policies tested (UserPolicyTest)
- [x] API token management tested (27 tests)
- [x] Form validation tested (Zod schemas)
- [x] UI components tested (button, input, dialog, etc.)

---

## IMPLEMENTATION_ORDER

Execute fixes in this priority order:

### Immediate (Before Production)
1. **SEC-001** - Restrict CORS to specific origins
2. **SEC-002** - Enable session encryption for production
3. **SEC-003** - Enable secure cookies for production
4. **PERF-002** - Reduce Inertia user payload size

### High Priority (First Sprint)
5. **PERF-001** - Fix N+1 query in ApiTokenController
6. **UX-001** - Add form data loss protection
7. **TEST-001** - Add E2E tests with Playwright

### Medium Priority (Second Sprint)
8. **PERF-003** - Queue email verification event
9. **UX-002** - Add aria-describedby for accessibility
10. **CODE-001** - Refactor timezone API call
11. **TEST-002** - Add model relationship tests

### Polish (Ongoing)
12. **LINT-001** - Fix ESLint warnings
13. **LINT-002** - Remove unused imports
14. **UX-003** through **UX-005** - Loading states, dark mode, focus styles
15. **CODE-002** through **CODE-004** - Extract hooks, use LoadingButton, export types

---

## NEXT_STEPS

Audit complete. To implement fixes:

1. Review findings for accuracy (some may be intentional design decisions)
2. Start new session for fresh context
3. Run: `/vibe-build AUDIT_REPORT_2026-02-05_0930.md`

**Estimated Effort:**
- P0 fixes: 1 item (~30 minutes)
- P1 fixes: 11 items (~8-12 hours)
- P2 fixes: 10 items (~4-6 hours)

**Recommended Approach:**
1. Fix SEC-001, SEC-002, SEC-003 immediately (environment config)
2. Use `/vibe-plan` to design E2E test strategy before implementing TEST-001
3. Run `/vibe-build` for remaining P1 items
4. P2 items can be addressed incrementally

---

## APPENDIX: Files Audited

### Backend (PHP)
- `app/Http/Controllers/` - All controllers
- `app/Http/Middleware/` - All middleware
- `app/Models/` - User, SocialAccount, UserSetting
- `app/Services/` - All services
- `app/Policies/` - UserPolicy
- `config/` - auth, cors, features, sanctum, session
- `routes/` - api.php, auth.php, web.php
- `tests/` - All 158 tests

### Frontend (TypeScript/React)
- `resources/js/Pages/` - All pages
- `resources/js/Components/` - All components
- `resources/js/Layouts/` - All layouts
- `resources/js/hooks/` - All hooks
- `resources/js/test/` - Test setup and mocks
- All 92 frontend tests
